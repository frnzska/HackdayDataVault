
  create or replace  view BLINKIST_DEV.hackday.facebook_ads_insights_staging_hashed
  
   as (
    







-- Generated by dbtvault.



WITH source_data AS (

    SELECT

    "AD_ID",
    "DATE",
    "COUNTRY",
    "ACCOUNT_ID",
    "ADSET_ID",
    "CLICKS",
    "IMPRESSIONS",
    "INLINE_LINK_CLICKS",
    "UNIQUE_CLICKS",
    "UNIQUE_INLINE_LINK_CLICKS",
    "FULL_VIEW_REACH",
    "COST_PER_INLINE_LINK_CLICK",
    "COST_PER_INLINE_POST_ENGAGEMENT",
    "COST_PER_UNIQUE_CLICK",
    "COST_PER_UNIQUE_INLINE_LINK_CLICK",
    "COST_PER_ESTIMATED_AD_RECALLERS",
    "SOCIAL_SPEND",
    "UNIQUE_LINK_CLICKS_CTR",
    "ESTIMATED_AD_RECALL_RATE",
    "ESTIMATED_AD_RECALLERS",
    "UNIQUE_CTR",
    "UNIQUE_INLINE_LINK_CLICK_CTR",
    "CPC",
    "CPM",
    "CPP",
    "CTR",
    "FREQUENCY",
    "SPEND",
    "ACCOUNT_NAME",
    "AD_NAME",
    "INLINE_LINK_CLICK_CTR",
    "INLINE_POST_ENGAGEMENT",
    "LOCATION",
    "OBJECTIVE",
    "_FIVETRAN_SYNCED"

    FROM BLINKIST_DEV.hackday.facebook_ads_insights_staging_raw
),

derived_columns AS (

    SELECT

    "AD_ID",
    "DATE",
    "COUNTRY",
    "ACCOUNT_ID",
    "ADSET_ID",
    "CLICKS",
    "IMPRESSIONS",
    "INLINE_LINK_CLICKS",
    "UNIQUE_CLICKS",
    "UNIQUE_INLINE_LINK_CLICKS",
    "FULL_VIEW_REACH",
    "COST_PER_INLINE_LINK_CLICK",
    "COST_PER_INLINE_POST_ENGAGEMENT",
    "COST_PER_UNIQUE_CLICK",
    "COST_PER_UNIQUE_INLINE_LINK_CLICK",
    "COST_PER_ESTIMATED_AD_RECALLERS",
    "SOCIAL_SPEND",
    "UNIQUE_LINK_CLICKS_CTR",
    "ESTIMATED_AD_RECALL_RATE",
    "ESTIMATED_AD_RECALLERS",
    "UNIQUE_CTR",
    "UNIQUE_INLINE_LINK_CLICK_CTR",
    "CPC",
    "CPM",
    "CPP",
    "CTR",
    "FREQUENCY",
    "SPEND",
    "ACCOUNT_NAME",
    "AD_NAME",
    "INLINE_LINK_CLICK_CTR",
    "INLINE_POST_ENGAGEMENT",
    "LOCATION",
    "OBJECTIVE",
    "_FIVETRAN_SYNCED",
    'FIVETRAN_FACEBOOK_ADS_INSIGHTS_RAW' AS "RECORD_SOURCE",
    "COUNTRY" AS "COUNTRY_CODE"

    FROM source_data
),

hashed_columns AS (

    SELECT

    "AD_ID",
    "DATE",
    "COUNTRY",
    "ACCOUNT_ID",
    "ADSET_ID",
    "CLICKS",
    "IMPRESSIONS",
    "INLINE_LINK_CLICKS",
    "UNIQUE_CLICKS",
    "UNIQUE_INLINE_LINK_CLICKS",
    "FULL_VIEW_REACH",
    "COST_PER_INLINE_LINK_CLICK",
    "COST_PER_INLINE_POST_ENGAGEMENT",
    "COST_PER_UNIQUE_CLICK",
    "COST_PER_UNIQUE_INLINE_LINK_CLICK",
    "COST_PER_ESTIMATED_AD_RECALLERS",
    "SOCIAL_SPEND",
    "UNIQUE_LINK_CLICKS_CTR",
    "ESTIMATED_AD_RECALL_RATE",
    "ESTIMATED_AD_RECALLERS",
    "UNIQUE_CTR",
    "UNIQUE_INLINE_LINK_CLICK_CTR",
    "CPC",
    "CPM",
    "CPP",
    "CTR",
    "FREQUENCY",
    "SPEND",
    "ACCOUNT_NAME",
    "AD_NAME",
    "INLINE_LINK_CLICK_CTR",
    "INLINE_POST_ENGAGEMENT",
    "LOCATION",
    "OBJECTIVE",
    "_FIVETRAN_SYNCED",
    "RECORD_SOURCE",
    "COUNTRY_CODE",

    CAST(MD5_BINARY(NULLIF(CONCAT_WS('||',
        IFNULL(NULLIF(UPPER(TRIM(CAST("COUNTRY_CODE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("DATE" AS VARCHAR))), ''), '^^'),
        IFNULL(NULLIF(UPPER(TRIM(CAST("AD_ID" AS VARCHAR))), ''), '^^')
    ), '^^||^^||^^')) AS BINARY(16)) AS "FACEBOOK_ADS_INSIGHTS_HK"

    FROM derived_columns
),

columns_to_select AS (

    SELECT

    "AD_ID",
    "DATE",
    "COUNTRY",
    "ACCOUNT_ID",
    "ADSET_ID",
    "CLICKS",
    "IMPRESSIONS",
    "INLINE_LINK_CLICKS",
    "UNIQUE_CLICKS",
    "UNIQUE_INLINE_LINK_CLICKS",
    "FULL_VIEW_REACH",
    "COST_PER_INLINE_LINK_CLICK",
    "COST_PER_INLINE_POST_ENGAGEMENT",
    "COST_PER_UNIQUE_CLICK",
    "COST_PER_UNIQUE_INLINE_LINK_CLICK",
    "COST_PER_ESTIMATED_AD_RECALLERS",
    "SOCIAL_SPEND",
    "UNIQUE_LINK_CLICKS_CTR",
    "ESTIMATED_AD_RECALL_RATE",
    "ESTIMATED_AD_RECALLERS",
    "UNIQUE_CTR",
    "UNIQUE_INLINE_LINK_CLICK_CTR",
    "CPC",
    "CPM",
    "CPP",
    "CTR",
    "FREQUENCY",
    "SPEND",
    "ACCOUNT_NAME",
    "AD_NAME",
    "INLINE_LINK_CLICK_CTR",
    "INLINE_POST_ENGAGEMENT",
    "LOCATION",
    "OBJECTIVE",
    "_FIVETRAN_SYNCED",
    "RECORD_SOURCE",
    "COUNTRY_CODE",
    "FACEBOOK_ADS_INSIGHTS_HK"

    FROM hashed_columns
)

SELECT * FROM columns_to_select
  );
